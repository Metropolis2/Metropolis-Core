<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

		<style>
.table-sticky-head {
	overflow: auto;
	height: 600px;
}

.table-sticky-head tr.first th {
	position: sticky;
	top: 0;
	z-index: 1;
	box-shadow: inset 1px 1px #000, 0 1px #000;
}

.table-sticky-head tr.second th {
	position: sticky;
	z-index: 1;
	box-shadow: inset 1px 1px #000, 0 1px #000;
}
		</style>

		<title>METROPOLIS2 Simulation Report</title>
	</head>
	<body>
		<h1>METROPOLIS2 Simulation Report</h1>

		<h2>Convergence</h2>

		<div class="table-responsive table-sticky-head">
			<table class="table table-striped table-bordered table-hover table-sm">
				<thead class="thead-light">
					<tr class="first">
						<th scope="col" rowspan="2" class="text-center">Iteration</th>
						<th scope="col" rowspan="2" class="text-center">Agent-level expected utility</th>
						<th scope="col" colspan="2" class="text-center">No-trip alternatives</th>
						<th scope="col" colspan="8" class="text-center">Alternative-level</th>
						<th scope="col" colspan="22" class="text-center">Road-trips level</th>
						<th scope="col" colspan="10" class="text-center">Virtual-trip level</th>
						<th scope="col" colspan="2" class="text-center">Road Network</th>
					</tr>
					<tr class="second">
						<!-- CONSTANT UTILITY -->
						<th scope="col" class="text-center">#</th>
						<th scope="col" class="text-center">Mean utility</th>
						<!-- TRIPS -->
						<th scope="col" class="text-center">#</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean utility</th>
						<th scope="col" class="text-center">Mean expected utility</th>
						<th scope="col" class="text-center">Mean departure-time shift</th>
						<th scope="col" class="text-center">Departure time RMSE</th>
						<!-- ROAD LEGS -->
						<th scope="col" class="text-center"># Trips</th>
						<th scope="col" class="text-center"># Alternatives (1+ road trip)</th>
						<th scope="col" class="text-center"># Alternatives (only road trips)</th>
						<th scope="col" class="text-center">Mean # road trips</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean road time</th>
						<th scope="col" class="text-center">Mean in-bottleneck time</th>
						<th scope="col" class="text-center">Mean out-bottleneck time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean route free-flow travel time</th>
						<th scope="col" class="text-center">Mean global free-flow travel time</th>
						<th scope="col" class="text-center">Mean route congestion</th>
						<th scope="col" class="text-center">Mean global congestion</th>
						<th scope="col" class="text-center">Mean route length (m)</th>
						<th scope="col" class="text-center">Mean edge count</th>
						<th scope="col" class="text-center">Mean utility</th>
						<th scope="col" class="text-center">Mean expected travel time</th>
						<th scope="col" class="text-center">Mean expected travel time difference (rel.)</th>
						<th scope="col" class="text-center">Mean expected travel time difference (abs.)</th>
						<th scope="col" class="text-center">Expected travel time difference RMSE</th>
						<th scope="col" class="text-center">Mean length difference (m)</th>
						<!-- VIRTUAL LEGS -->
						<th scope="col" class="text-center"># Trips</th>
						<th scope="col" class="text-center"># Alternatives (1+ virtual trip)</th>
						<th scope="col" class="text-center"># Alternatives (only virtual trips)</th>
						<th scope="col" class="text-center">Mean # virtual trips</th>
						<th scope="col" class="text-center">Mean departure time</th>
						<th scope="col" class="text-center">Mean arrival time</th>
						<th scope="col" class="text-center">Mean travel time</th>
						<th scope="col" class="text-center">Mean global free-flow travel time</th>
						<th scope="col" class="text-center">Mean global congestion</th>
						<th scope="col" class="text-center">Mean utility</th>
						<!-- ROAD NETWORK -->
						<th scope="col" class="text-center">Simulated road-network conditions RMSE</th>
						<th scope="col" class="text-center">Expected road-network conditions RMSE</th>
					</tr>
				</thead>
				<tbody>
					{% for it in iterations %}
					<tr>
						<td scope="row" class="text-center">{{ loop.index }}</td>
						<td class="text-center">{{ "{:.4}"|format(it.surplus.mean().0) }}</td>
						{% match it.mode_results.constant %}
							{% when Some with (constant) %}
								<td class="text-center">{{ constant.count }}</td>
								<td class="text-center">{{ constant.utility.mean() }}</td>
							{% when None %}
								<td class="text-center">0</td>
								<td class="text-center">N/A</td>
						{% endmatch %}
						{% match it.mode_results.trip_modes %}
							{% when Some with (trip_results) %}
								<!-- TRIPS -->
								<td class="text-center">{{ trip_results.count }}</td>
								<td class="text-center">{{ "{}"|format(trip_results.departure_time.mean()) }}</td>
								<td class="text-center">{{ "{}"|format(trip_results.arrival_time.mean()) }}</td>
								<td class="text-center">{{ "{}"|format(trip_results.travel_time.mean()) }}</td>
								<td class="text-center">{{ "{:.4}"|format(trip_results.utility.mean().0) }}</td>
								<td class="text-center">{{ "{:.4}"|format(trip_results.expected_utility.mean().0) }}</td>
								{% match trip_results.dep_time_shift %}
									{% when Some with (distr) %}
									<td class="text-center">{{ "{}"|format(distr.mean()) }}</td>
									{% when None %}
									<td class="text-center">N/A</td>
								{% endmatch %}
								{% match trip_results.dep_time_rmse %}
									{% when Some with (value) %}
									<td class="text-center">{{ "{}"|format(value) }}</td>
									{% when None %}
									<td class="text-center">N/A</td>
								{% endmatch %}
								<!-- ROAD LEGS -->
								{% match trip_results.road_leg %}
									{% when Some with (rlr) %}
									<td class="text-center">{{ rlr.count }}</td>
									<td class="text-center">{{ rlr.mode_count_one }}</td>
									<td class="text-center">{{ rlr.mode_count_all }}</td>
									<td class="text-center">{{ "{:.4}"|format(rlr.count_distribution.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.departure_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.arrival_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.road_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.in_bottleneck_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.out_bottleneck_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.travel_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.route_free_flow_travel_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.global_free_flow_travel_time.mean()) }}</td>
									<td class="text-center">{{ "{:.4}"|format(rlr.route_congestion.mean()) }}</td>
									<td class="text-center">{{ "{:.4}"|format(rlr.global_congestion.mean()) }}</td>
									<td class="text-center">{{ "{:.0}"|format(rlr.length.mean().0) }}</td>
									<td class="text-center">{{ "{:.2}"|format(rlr.edge_count.mean()) }}</td>
									<td class="text-center">{{ "{:.4}"|format(rlr.utility.mean().0) }}</td>
									<td class="text-center">{{ "{:.4}"|format(rlr.exp_travel_time.mean()) }}</td>
									<td class="text-center">{{ "{:.4}"|format(rlr.exp_travel_time_rel_diff.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.exp_travel_time_abs_diff.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(rlr.exp_travel_time_diff_rmse) }}</td>
									{% match rlr.length_diff %}
										{% when Some with (distr) %}
										<td class="text-center">{{ "{:.2}"|format(distr.mean().0) }}</td>
										{% when None %}
										<td class="text-center">N/A</td>
									{% endmatch %}
									{% when None %}
									{% for _ in 0..20 %}
									<td class="text-center">N/A</td>
									{% endfor %}
								{% endmatch %}
								<!-- VIRTUAL LEGS -->
								{% match trip_results.virtual_leg %}
									{% when Some with (vlr) %}
									<td class="text-center">{{ vlr.count }}</td>
									<td class="text-center">{{ vlr.mode_count_one }}</td>
									<td class="text-center">{{ vlr.mode_count_all }}</td>
									<td class="text-center">{{ "{:.4}"|format(vlr.count_distribution.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(vlr.departure_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(vlr.arrival_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(vlr.travel_time.mean()) }}</td>
									<td class="text-center">{{ "{}"|format(vlr.global_free_flow_travel_time.mean()) }}</td>
									<td class="text-center">{{ "{:.4}"|format(vlr.global_congestion.mean()) }}</td>
									<td class="text-center">{{ "{:.4}"|format(vlr.utility.mean().0) }}</td>
									{% when None %}
									{% for _ in 0..10 %}
									<td class="text-center">N/A</td>
									{% endfor %}
								{% endmatch %}
							{% when None %}
								<td class="text-center">0</td>
								{% for _ in 0..35 %}
								<td class="text-center">N/A</td>
								{% endfor %}
						{% endmatch %}
						{% match it.sim_road_network_weights_rmse %}
							{% when Some with (value) %}
							<td class="text-center">{{ "{:.4}"|format(value.0) }}</td>
							{% when None %}
							<td class="text-center">N/A</td>
						{% endmatch %}
						{% match it.exp_road_network_weights_rmse %}
							{% when Some with (value) %}
							<td class="text-center">{{ "{:.4}"|format(value.0) }}</td>
							{% when None %}
							<td class="text-center">N/A</td>
						{% endmatch %}
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<ul class="nav nav-tabs">
			<li class="nav-item">
				<a class="nav-link active" id="surplus-tab" data-toggle="tab" href="#surplus" role="tab">Agent Expected Utility (Surplus)</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="mean_departure_time-tab" data-toggle="tab" href="#mean_departure_time" role="tab">Mean Departure Time</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="dt_rmse-tab" data-toggle="tab" href="#dt_rmse" role="tab">Departure Time RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="travel_time-tab" data-toggle="tab" href="#travel_time" role="tab">Mean Travel Time</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="expect_rmse-tab" data-toggle="tab" href="#expect_rmse" role="tab">Expected Travel Time Diff RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="sim_rn_cond_rmse-tab" data-toggle="tab" href="#sim_rn_cond_rmse" role="tab">Simulated Road Network Conditions RMSE</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="exp_rn_cond_rmse-tab" data-toggle="tab" href="#exp_rn_cond_rmse" role="tab">Expected Road Network Conditions RMSE</a>
			</li>
		</ul>

		<div class="tab-content" id="convergenceCharts">
			<div class="tab-pane fade show active" id="surplus" role="tabpanel">
				<div id="surplusChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="mean_departure_time" role="tabpanel">
				<div id="meanDepartureTimeChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="dt_rmse" role="tabpanel">
				<div id="dtRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="travel_time" role="tabpanel">
				<div id="travelTimeChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="expect_rmse" role="tabpanel">
				<div id="expectRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="sim_rn_cond_rmse" role="tabpanel">
				<div id="simRnCondRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
			<div class="tab-pane fade" id="exp_rn_cond_rmse" role="tabpanel">
				<div id="expRnCondRmseChart" style="height: 600px; width: 1000px"></div>
			</div>
		</div>

		<h2>Last Iteration</h2>

		<div id="roadDepartureTimeHist" style="height: 600px; width: 1000px"></div>

		<div id="roadArrivalTimeHist" style="height: 600px; width: 1000px"></div>

		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>

		<script>
			const data = {{iterations|json|safe}};

			var road_departure_times = {{last_iteration.road_departure_times|json|safe}};
			var road_arrival_times = {{last_iteration.road_arrival_times|json|safe}};

			$(document).ready(function() {
							var firstHeight = $('.first').height();
							$("thead tr.second th").css("top", firstHeight)
						});

			var iters = [];
			var surplus = [];
			var mean_departure_time = [];
			var dt_rmse = [];
			var travel_time = [];
			var expect_rmse = [];
			var sim_rn_cond_rmse = [];
			var exp_rn_cond_rmse = [];
			for (let i = 0; i < data.length; i++) {
				iters.push(i + 1);
				// Surplus
				surplus.push(data[i].surplus.mean);
				// Mean departure time
				var t = new Date(0);
				t.setSeconds(data[i].mode_results.trip_modes.departure_time.mean);
				mean_departure_time.push(t.toISOString());
				// Departure time RMSE
				var t = new Date(0);
				t.setSeconds(data[i].mode_results.trip_modes.dep_time_rmse);
				dt_rmse.push(t.toISOString());
				// Mean travel time
				var t = new Date(0);
				t.setSeconds(data[i].mode_results.trip_modes.travel_time.mean);
				travel_time.push(t.toISOString());
				// Exp. travel time diff RMSE
				var t = new Date(0);
				t.setSeconds(data[i].mode_results.trip_modes.road_leg.exp_travel_time_diff_rmse);
				expect_rmse.push(t.toISOString());
				// Sim. road network conditions RMSE
				var t = new Date(0);
				t.setSeconds(data[i].sim_road_network_weights_rmse);
				sim_rn_cond_rmse.push(t.toISOString());
				// Exp. road network conditions RMSE
				var t = new Date(0);
				t.setSeconds(data[i].exp_road_network_weights_rmse);
				exp_rn_cond_rmse.push(t.toISOString());
			}

			var surplus_trace = {
							x: iters,
							y: surplus,
							type: 'scatter'
						};
			Plotly.newPlot('surplusChart', [surplus_trace]);

			var mean_departure_time_trace = {
							x: iters,
							y: mean_departure_time,
							type: 'scatter'
						};
			var layout = {
							yaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('meanDepartureTimeChart', [mean_departure_time_trace], layout);

			var dt_rmse_trace = {
							x: iters,
							y: dt_rmse,
							type: 'scatter'
						};
			var layout = {
							yaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('dtRmseChart', [dt_rmse_trace], layout);

			var travel_time_trace = {
							x: iters,
							y: travel_time,
							type: 'scatter'
						};
			var layout = {
							yaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('travelTimeChart', [travel_time_trace], layout);

			var expect_rmse_trace = {
							x: iters,
							y: expect_rmse,
							type: 'scatter'
						};
			var layout = {
							yaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('expectRmseChart', [expect_rmse_trace], layout);

			var sim_rn_cond_rmse_trace = {
							x: iters,
							y: sim_rn_cond_rmse,
							type: 'scatter'
						};
			var layout = {
							yaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('simRnCondRmseChart', [sim_rn_cond_rmse_trace], layout);

			var exp_rn_cond_rmse_trace = {
							x: iters,
							y: exp_rn_cond_rmse,
							type: 'scatter'
						};
			var layout = {
							yaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('expRnCondRmseChart', [exp_rn_cond_rmse_trace], layout);

			road_departure_times = road_departure_times.map(function(v) {
							var t = new Date(0);
							t.setSeconds(v);
							return t.toISOString();
						});
			var road_departure_times_trace = {
							x: road_departure_times,
							type: 'histogram',
								histnorm: 'probability',
						};
			var layout = {
							title: "Departure times distribution",
							xaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('roadDepartureTimeHist', [road_departure_times_trace], layout);

			road_arrival_times = road_arrival_times.map(function(v) {
							var t = new Date(0);
							t.setSeconds(v);
							return t.toISOString();
						});
			var road_arrival_times_trace = {
							x: road_arrival_times,
							type: 'histogram',
								histnorm: 'probability',
						};
			var layout = {
							title: "Arrival times distribution",
							xaxis: {
											tickformat: "%H:%M:%S"
										}
						};
			Plotly.newPlot('roadArrivalTimeHist', [road_arrival_times_trace], layout);
		</script>
	</body>
</html>
